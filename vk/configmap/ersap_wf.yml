kind: ConfigMap
apiVersion: v1
metadata:
  name: wf-test
  namespace: default
data:
  wf.sh: |
    #!/bin/bash
    echo $HOME
    # shifter --image=docker:gurjyan/ersap:v0.4 --entrypoint
    shifter --image=docker:gurjyan/ersap:v0.4 -- /bin/bash /ersap/run-pipeline-4.sh
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: prom-test
  namespace: default
data:
  prom.sh: |
    #!/bin/bash
    sleep 10
    
    for i in {2221..2224}
    do
      j=$((i + 10000))
      ssh -NfR $j:localhost:$i $PROM_SERVER
    done

    echo $PGID_FILE, $PROM_SERVER, $PROCESS_EXPORTER_PORT, $HOME

    ssh -NfR $PROCESS_EXPORTER_PORT:localhost:$PROCESS_EXPORTER_PORT $PROM_SERVER 
    shifter --image=jlabtsai/process-exporter:pgid-go -V /proc:/host_proc --entrypoint

---

apiVersion: v1
kind: Pod
metadata:
  name: ersap-test
spec:
  containers:
    - name: wf
      image: wf
      command: ["/bin/bash", "-c"]
      args: ["bash $workdrir/wf.sh > $workdrir/stdout 2> $workdrir/stderr"]
      env:
        - name: workdrir
          value: ~/ersap/test-run/wf
        - name: HOME
          value: $HOME

      volumeMounts:
        - name: wf
          mountPath: ~/ersap/test-run/wf
        - name: pgid-wf
          mountPath: ~/ersap/test-run/wf/pgid

      resources:
        limits:
          cpu: "32"
          memory: 128Gi

    - name: prom
      image: prom
      command: ["/bin/bash", "-c"]
      args: ["bash $workdir/prom.sh > $workdir/stdout 2> $workdir/stderr"]
      env:
        - name: workdir
          value: ~/ersap/test-run/prom
        - name: PGID_FILE
          value: ~/ersap/test-run/wf/pgid/wf.pgid
        - name: PROM_SERVER
          value: jeng-yuantsai@72.84.73.170
        - name: PROCESS_EXPORTER_PORT
          value: "12345"
        - name: HOME
          value: $HOME

        # - name: CMDS_FOR_CONFIG
        #   value: "stress-ng-cpu"
        # - name: GROUP_FOR_CONFIG
        #   value: "{{.ExeBase}}:{{.Username}}:{{.PID}}"


      volumeMounts:
        - name: prom
          mountPath: ~/ersap/test-run/prom
        - name: pgid-prom
          mountPath: ~/ersap/test-run/prom/pgid

      resources:
        limits:
          cpu: "32"
          memory: 128Gi


  volumes:
    - name: wf
      configMap:
        name: wf-test
    - name: prom
      configMap:
        name: prom-test
    - name: pgid-wf
      emptyDir: {}
    - name: pgid-prom
      emptyDir: {}
        
  nodeSelector:
    kubernetes.io/role: agent
    kubernetes.io/hostname: ersap-test
  tolerations:
    - key: "virtual-kubelet.io/provider"
      value: "mock"
      effect: "NoSchedule"


---
